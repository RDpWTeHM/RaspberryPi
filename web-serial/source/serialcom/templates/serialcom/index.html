{# source/serialcom/templates/serialcom/index.html #}
<!DOCTYPE html>
<html>
<head>
	<title>SerialCOM</title>

<script type="text/javascript">
/**
 * utils function:
 */
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

	async function waitBack2ConnectText() {
	  await sleep(3000);
	  document.getElementById("connect").value = "Connect";
	}
	async function waitBack2DisconnectText() {
	  await sleep(3000);
	  document.getElementById("connect").value = "Disconnect";
	}

	function connect_serial(){
		var xmlhttp;
		if (window.XMLHttpRequest)
		{
		    //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
		    xmlhttp=new XMLHttpRequest();
		}else{
		    // IE6, IE5 浏览器执行代码
		    xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		}
		
		xmlhttp.open("POST", "/serialcom/connect/", true);
		xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");

		var conn_status = document.getElementById("connect").value;
		if (conn_status == "Connect"){
			xmlhttp.send("connect=" + conn_status +
						 "&device_select=" + document.getElementById("device_select").value +
				         "&baud=" + document.getElementById("baud").value +
				         "&csrfmiddlewaretoken=" + document.getElementsByName("csrfmiddlewaretoken")[0].value);
		}else if(conn_status == "Disconnect"){
			xmlhttp.send("connect=" + conn_status +
				         "&csrfmiddlewaretoken=" + document.getElementsByName("csrfmiddlewaretoken")[0].value);
		}
		var IsConnected = ""
		xmlhttp.onreadystatechange=function()
		{
			if (xmlhttp.readyState==4 && xmlhttp.status==200){
				IsConnected = xmlhttp.responseText;
				if (conn_status == "Connect"){
					if (IsConnected == "True"){
						document.getElementById("connect").value = "Disconnect";
					}else if(IsConnected == "False"){
						document.getElementById("connect").value = "FAIL connect!";
						waitBack2ConnectText();
					}
				}else if(conn_status == "Disconnect"){
					if (IsConnected == "False"){
						document.getElementById("connect").value = "Connect";
					}else if(IsConnected == "True"){
						document.getElementById("connect").value = "FAIL disconnect!";
						waitBack2DisconnectText();
					}
				}
			}
		}
	}
</script>
</head>
<body>
	<h1>Serial/COM</h1>

	<form action="" method="POST">
		<div>
			<label>Serial/COM:</label>
			<select name="device_select" id="device_select">
				<option>Select one Device</option>
			{% for device in serial.devices	%}
				<option>{{ device }}</option>
			{% endfor	%}
			</select>

			<label>Baud:</label>
			<input type="text" name="baud" id="baud"
			       value="9600"/>
			<br/>

			<input type="checkbox" name="advance"
			       value="advance">Advance
			<input type="button" name="connect" id="connect"
			       value="Connect" onclick="connect_serial()" />
			<!--<INPUT type="hidden" name="conn_status" id="conn_status" value="Disconnect"/>-->
		</div>
		{% csrf_token %}
	</form>
	<br/>
	<form>
		<div>
			<select>
				<option>串口助手模式</option>
				<option>Console 模式</option>
			</select>
		</div>
		<div>
			<textarea name="serial_recv" id="serial_recv"
			       rows="10" cols="30">
			</textarea>
			<br/>
			<input type="button" name="click_to_recv" id="click_to_recv"
			       value="Click to Receive" onclick="click2recv()" />
			<script>
				console.log("test could running??? " + Math.trunc(Math.random()*10));
				async function waitTest() {
	  				await sleep(1000);
	  				document.getElementById("serial_recv").value += "heheda\r\n";
				}
				waitTest();

				function click2recv(){
					var xmlhttp_recv;
					if (window.XMLHttpRequest){ //  IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
					    xmlhttp_recv=new XMLHttpRequest();
					}else{ // IE6, IE5 浏览器执行代码
					    xmlhttp_recv=new ActiveXObject("Microsoft.XMLHTTP");
					}
					
					xmlhttp_recv.open("GET",
						              "/serialcom/receive/?read=read&length=" +
						              Math.trunc(Math.random()*10), true);
					xmlhttp_recv.send();

					var str_recv = ""
					xmlhttp_recv.onreadystatechange=function()
					{
						if (xmlhttp_recv.readyState==4 && xmlhttp_recv.status==200){
							str_recv = xmlhttp_recv.responseText;
							document.getElementById("serial_recv").value += str_recv;
						}
					}
				}
			</script>
			<br/>
			<input type="text" name="ser_tx">
			<input type="button" name="tx_send" value="SEND"/>
		</div>

		{% csrf_token %}
	</form>
</body>
</html>
